// ===== PART 1: accommodationService.js =====
// Replace your existing getUserAccommodations function with this:

/**
 * Get user accommodations - only for landlords, returns empty for students
 * WHY: Students don't own accommodations, only landlords do
 */
export const getUserAccommodations = async (user) => {
  try {
    console.log('üë§ Getting accommodations for user:', user?.id, user?.username, user?.role?.name);
    
    if (!user) {
      console.log('‚ùå No user provided');
      return [];
    }

    const userRole = user.role?.name;
    
    // ===== IMPORTANT: Students don't have accommodations =====
    if (userRole === 'student') {
      console.log('üéì User is a student - no accommodations to fetch');
      return []; // Return empty array for students
    }
    
    // ===== ONLY landlords have accommodations =====
    if (userRole === 'landlord') {
      console.log('üè† User is a landlord - fetching accommodations');
      const landlordId = await getLandlordId(user);
      
      if (!landlordId) {
        console.log('‚ùå No landlord ID found for landlord user');
        return [];
      }

      const response = await client.query({
        query: gql`
          query GetLandlordAccommodations($landlordId: ID!) {
            accommodations(filters: { landlord: { documentId: { eq: $landlordId } } }) {
              documentId
              id
              name
              details {
                price
                Bedrooms
                Bathrooms
                Category
                distance
                isFull
                Facilities {
                  wifi
                  solar
                  gas
                  security
                  kitchen
                  SwimmingPool
                }
              }
              location {
                Address
                City
                longitude
                latitude
              }
              media {
                CoverImage {
                  alternativeText
                  url
                }
                Gallery {
                  alternativeText
                  url
                }
                Rooms {
                  alternativeText
                  url
                }
              }
              landlord {
                documentId
                fullName
              }
              likes
              status
              views
              favorites
              inquiries
              createdAt
              updatedAt
            }
          }
        `,
        variables: { landlordId },
        fetchPolicy: 'network-only'
      });

      const accommodations = response.data?.accommodations || [];
      console.log(`‚úÖ Found ${accommodations.length} accommodations for landlord ${landlordId}`);
      return accommodations;
    }

    console.log('‚ùì Unknown user role:', userRole);
    return [];
    
  } catch (error) {
    console.error('‚ùå Error in getUserAccommodations:', error);
    
    // ===== CRITICAL: Don't throw error for students =====
    if (user?.role?.name === 'student') {
      return []; // Students don't have accommodations, so no error
    }
    
    // For landlords, throw the error so they know there's an issue
    throw new Error(`Failed to fetch landlord accommodations: ${error.message}`);
  }
};

// ===== PART 2: AppContext.js =====
// Replace your accommodation loading useEffect with this:

useEffect(() => {
  const loadUserAccommodations = async () => {
    if (!user) {
      setUserAccommodations([]);
      return;
    }

    try {
      console.log('üîç Loading accommodations for user:', user.id, user.username, user.role?.name);
      
      // ===== CRITICAL LOGIC: Only load for landlords =====
      if (user.role?.name === 'landlord') {
        const accommodations = await getUserAccommodations(user);
        console.log('üì¶ Landlord accommodations received:', accommodations.length);
        
        // Filter valid accommodations
        const validAccommodations = accommodations.filter(acc => 
          acc && acc.id && (acc.name || acc.location?.Address)
        );
        console.log('‚úÖ Valid landlord accommodations:', validAccommodations.length);
        
        setUserAccommodations(validAccommodations);
      } else {
        // ===== STUDENTS: Set empty array (they don't own properties) =====
        console.log('üéì User is student - setting empty accommodations array');
        setUserAccommodations([]);
      }
      
    } catch (error) {
      console.error('‚ùå Error loading user accommodations:', error);
      
      // ===== IMPORTANT: Different handling for students vs landlords =====
      if (user.role?.name === 'student') {
        setUserAccommodations([]); // Normal for students - no error
      } else {
        // For landlords, show error but set empty array
        console.error('Failed to load landlord accommodations:', error.message);
        setUserAccommodations([]);
      }
    }
  };

  loadUserAccommodations();
}, [user]);

// ===== PART 3: Dashboard.jsx =====  
// Replace the redirect useEffect with this:

useEffect(() => {
  if (user) {
    const userRole = getUserRole();
    
    // ===== SMART REDIRECT: Only redirect confirmed landlords =====
    if (userRole === 'landlord') {
      console.log('üè† User is landlord, redirecting to landlord dashboard');
      window.location.href = '/LandlordDash';
      return;
    }
    
    // ===== STUDENTS & OTHERS: Stay on student dashboard =====
    console.log('üéì User is student - staying on student dashboard');
    refreshInquiries?.();
  }
}, [user, getUserRole, refreshInquiries]);

// ===== PART 4: inquiryService.js =====
// Create this new file or add these functions:

/**
 * Create inquiry from student to landlord
 * WHY: Students need to contact landlords about properties
 */
export const createInquiry = async (inquiryData) => {
  try {
    console.log('üì§ Creating inquiry from student to landlord:', inquiryData);
    
    const { propertyId, propertyName, landlordId, userName, userEmail, userPhone, message, preferredDate } = inquiryData;

    const response = await client.mutate({
      mutation: gql`
        mutation CreateInquiry($data: InquiryInput!) {
          createInquiry(data: $data) {
            documentId
            id
            propertyId
            propertyName
            landlordId
            userName
            userEmail
            userPhone
            userRole
            studentId
            message
            preferredDate
            state
            landlordReply
            counterDate
            createdAt
            updatedAt
          }
        }
      `,
      variables: {
        data: {
          propertyId,
          propertyName,
          landlordId, // ===== TARGET: Landlord's documentId =====
          userName,
          userEmail,
          userPhone,
          userRole: 'student', // ===== SOURCE: Always student sending inquiry =====
          studentId: inquiryData.studentId || null,
          message,
          preferredDate,
          state: 'unread' // ===== STATUS: Starts as unread =====
        }
      }
    });

    console.log('‚úÖ Inquiry created successfully');
    return { success: true, data: response.data.createInquiry };
    
  } catch (error) {
    console.error('‚ùå Error creating inquiry:', error);
    return { success: false, error: error.message };
  }
};

/**
 * Get inquiries for a landlord (inquiries sent to their properties)
 * WHY: Landlords need to see inquiries from students
 */
export const getLandlordInquiries = async (landlordDocumentId) => {
  try {
    console.log('üì• Fetching inquiries for landlord:', landlordDocumentId);
    
    const response = await client.query({
      query: gql`
        query GetLandlordInquiries($landlordId: ID!) {
          inquiries(filters: { landlordId: { eq: $landlordId } }) {
            documentId
            id
            propertyId
            propertyName
            landlordId
            userName
            userEmail
            userPhone
            userRole
            studentId
            message
            preferredDate
            state
            landlordReply
            counterDate
            createdAt
            updatedAt
          }
        }
      `,
      variables: { landlordId: landlordDocumentId },
      fetchPolicy: 'network-only'
    });

    const inquiries = response.data?.inquiries || [];
    console.log(`‚úÖ Found ${inquiries.length} inquiries for landlord`);
    return inquiries;
    
  } catch (error) {
    console.error('‚ùå Error fetching landlord inquiries:', error);
    return [];
  }
};

/**
 * Get inquiries for a student (inquiries they sent)
 * WHY: Students need to track their sent inquiries
 */
export const getStudentInquiries = async (userEmail) => {
  try {
    console.log('üì• Fetching inquiries sent by student:', userEmail);
    
    const response = await client.query({
      query: gql`
        query GetStudentInquiries($userEmail: String!) {
          inquiries(filters: { userEmail: { eq: $userEmail } }) {
            documentId
            id
            propertyId
            propertyName
            landlordId
            userName
            userEmail
            userPhone
            userRole
            studentId
            message
            preferredDate
            state
            landlordReply
            counterDate
            createdAt
            updatedAt
          }
        }
      `,
      variables: { userEmail },
      fetchPolicy: 'network-only'
    });

    const inquiries = response.data?.inquiries || [];
    console.log(`‚úÖ Found ${inquiries.length} inquiries sent by student`);
    return inquiries;
    
  } catch (error) {
    console.error('‚ùå Error fetching student inquiries:', error);
    return [];
  }
};

// ===== PART 5: SingleProperty.jsx =====
// Replace the handleBookingSubmit function with this:

const handleBookingSubmit = async (e) => {
  e.preventDefault();
  
  if (!user) {
    setShowLoginPrompt(true);
    return;
  }

  // ===== SECURITY: Only students can send inquiries =====
  const userRole = getUserRole();
  if (userRole !== 'student') {
    alert('Only students can book viewing appointments.');
    return;
  }

  try {
    console.log('üì§ Student sending inquiry for property:', property.id);
    
    // ===== TARGET: Get landlord from property data =====
    const landlordId = property.landlord?.documentId;
    
    if (!landlordId) {
      alert('Cannot send inquiry: Property owner information not found');
      return;
    }

    const result = await createInquiry({
      propertyId: property.id,
      propertyName: property.name,
      landlordId: landlordId, // ===== CRITICAL: Landlord's documentId =====
      userName: bookingData.name || user.username,
      userEmail: bookingData.email || user.email,
      userPhone: bookingData.phone,
      message: bookingData.message,
      preferredDate: bookingData.date,
    });

    if (result.success) {
      setShowSuccess(true);
      setTimeout(() => setShowSuccess(false), 3000);
      setShowBookingForm(false);
      setBookingData({
        name: '',
        email: '',
        phone: '',
        date: '',
        message: ''
      });
      console.log('‚úÖ Inquiry sent successfully to landlord:', landlordId);
    } else {
      alert(`Failed to send inquiry: ${result.error}`);
    }
  } catch (error) {
    console.error('‚ùå Booking error:', error);
    alert('Failed to send inquiry. Please try again.');
  }
};